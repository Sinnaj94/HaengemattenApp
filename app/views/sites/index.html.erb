<p id="notice"><%= notice %></p>
<style>

</style>
<h1>Sites</h1>
<h2>My Map</h2>
<div id="map" style="width: 100%; height: 600px"></div>
<div style="display: none;">
  <!-- Clickable label for Vienna -->
  <a class="overlay" id="vienna" target="_blank" href="http://en.wikipedia.org/wiki/Vienna">Vienna</a>
  <div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
  </div>
</div>
<script>


    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');
    var overlay = new ol.Overlay({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    });


    // Adding all hammocks
    var hammocks = [];
    <% @sites.each do |site| %>
        var point = new ol.geom.Point([<%= site.longitude %>, <%= site.latitude %>]);
        point.transform('EPSG:4326', 'EPSG:900913');
      var hammock = new ol.Feature({
            geometry: point,
            name: '<%=site.name %>',
            description: '<%=site.description %>',
            user: {
                first: "<%= site.user.first_name %>",
                last: "<%= site.user.last_name %>"
            },
            review_count: <%= site.reviews.size %>,
            belongs_to_user: <%= site.user == current_user %>,
            <%if site.user == current_user%>
              edit: '<%= button_to "Bearbeiten", edit_site_path(site), :class => "btn btn-primary btn-block", :method => :get %>',
              delete: '<%= button_to "Löschen",  site, method: :delete, :class => "btn btn-warning btn-block" , confirm: 'Are you sure?' %>'
            <% end %>
        });
        hammocks.push(hammock);
    <% end %>

    var iconStyle = new ol.style.Style({
        image: new ol.style.Icon(/** @type {module:ol/style/Icon~Options} */ ({
            anchor: [0.5, 1],
            anchorXUnits: 'fraction',
            anchorYUnits: 'fraction',
            src: "<%= asset_path('hammock.png') %>"
        }))
    });

    hammocks.forEach(hammock => hammock.setStyle(iconStyle));

    var vectorSource = new ol.source.Vector({
        features: hammocks
    });

    var vectorLayer = new ol.layer.Vector({
        source: vectorSource
    });

    var tileLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });


    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    var map = new ol.Map({
        layers: [
            tileLayer,
            vectorLayer
        ],
        overlays: [overlay],
        target: 'map',
        view: new ol.View({
            center: [0, 0],
            zoom: 2
        })
    });



    map.on('singleclick', function(evt) {
        var coordinate = evt.coordinate;
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature) {
                return feature;
          });
        if(feature) {
            coordinate = feature.get("geometry").flatCoordinates;
            $(container).addClass("marker");
            content.innerHTML = featureToHTML(feature);
        } else {
            $(container).removeClass("marker");
            content.innerHTML = emptySlot();
        }
        overlay.setPosition(coordinate);
    });

    function featureToHTML(feature) {
        var comment = "Kommentare";
        if(feature.get("review_count") === 1) {
          comment = "Kommentar";
        }
        var isMine = feature.get("belongs_to_user");
        var postfix = "";
        if(isMine) {
            postfix = feature.get("edit") + feature.get("delete");
        }
        return "<h2>" + feature.get("name") + "</h2> " +
            "<span class='discoverer'>" + feature.get("user").first + " " + feature.get("user").last + "</span>" +
        "<div class='description'>" +
        feature.get("description") +
        "</div>" +
        "<a href='#'>" +
        feature.get("review_count") + " " + comment +
        "</a>" + postfix;
    }

    function emptySlot() {
        return "<p>Hier ist noch keine Hängematte abgespeichert worden!</p><button class='btn btn-primary'>Hängematte eintragen</button>";
    }

</script>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
	  <th>Author</th>
      <th>Longitude</th>
      <th>Latitude</th>
	  <th>Sizes</th>
	  <th>Reviews</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @sites.each do |site| %>
      <tr>
        <td><%= site.name %></td>
        <td><%= site.description %></td>
		<td><%= site.user.first_name %> <%= site.user.last_name %></td>
        <td><%= site.longitude %></td>
        <td><%= site.latitude %></td>
		<td><%= site.sizes.map(&:name).join(', ') %></td>
		<td><%= site.reviews.size %> reviews</td>
        <td><%= link_to '<i class="fa fa-search"></i>'.html_safe, site %></td>
		<% if current_user %>
		<% if site.user_id==current_user.id %>
			<td><%= link_to '<i class="fa fa-pencil"></i>'.html_safe, edit_site_path(site) %></td>
			<td><%= link_to '<i class="fa fa-trash"></i>'.html_safe, site, method: :delete, data: { confirm: 'Are you sure?' } %></td>
		<% end %>
		<% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Site', new_site_path %>
